## Учебный конфигурационный язык — CLI-инструмент (Вариант №2)

Инструмент командной строки на Java, который:
- читает файл с текстом на учебном конфигурационном языке;
- разбирает его с помощью **ANTLR4**;
- при успешном разборе выводит XML-представление в стандартный вывод;
- при синтаксических/лексических ошибках выводит сообщение об ошибке в стандартный поток ошибок.

### 1. Общее описание языка

- **Комментарии**: однострочные
  - `// Это однострочный комментарий`
- **Числа**: двоичные в виде
  - `0[bB][01]+`, например: `0b1010`, `0B0011`
  - внутри программы числа используются как целые в десятичной системе.
- **Имена (идентификаторы)**:
  - `[a-zA-Z][_a-zA-Z0-9]*`
- **Словари**:
  - Общий вид:
    - `[ имя => значение, имя => значение, ... ]`
  - Значение:
    - число;
    - словарь (возможна вложенность).
- **Объявление константы**:
  - `var имя значение`
  - В данном решении значение константы — **только число** (для упрощения арифметики).
- **Вычисление константного выражения** (префиксная форма):
  - Общий вид: `^(expr)`
  - Примеры:
    - `^(+ base 1)`
    - `^(+ a b)`
    - `^(sqrt x)`
- **Операции константных выражений**:
  - сложение: `+` (либо константа + число, либо константа + константа);
  - корень: `sqrt` (целая часть квадратного корня, `long`).

Все ошибки лексического и синтаксического разбора перехватываются и отображаются как `Syntax error: ...`.

### 2. Функции и поведение инструмента

- **Разбор с ANTLR4**:
  - грамматика: `ConfigLang.g4` (директория `src/main/antlr4`);
  - плагины Maven автоматически генерируют лексер и парсер в пакете `org.example.parser`.

- **Объявления констант** (`var`):
  - пример: `var basePort 0b100000`
  - сохраняются во внутреннем окружении констант (`ConstEnvironment`) как `long` (двоичные строки преобразуются в десятичное значение).
  - в XML отражаются как:
    - `<const name="basePort" value="32"/>`

- **Константные выражения**:
  - пример сложения: `^(+ base 0b000010)`
  - пример корня: `^(sqrt maxPlayers)`
  - вычисляются во время трансляции (`ConstEvaluator`).
  - в XML результат выражения отображается как:
    - `<constExpr result="34">...</constExpr>`

- **Словари**:
  - пример:
    - `[ host => 0b0001, port => 0b1010 ]`
  - в XML представление:
    - `<dict>`
      - `<entry name="host"><number>1</number></entry>`
      - `<entry name="port"><number>10</number></entry>`
    - `</dict>`
  - поддерживаются вложенные словари.

- **Обработка ошибок**:
  - специальный обработчик ошибок ANTLR: `ThrowingErrorListener`;
  - навешивается и на лексер, и на парсер;
  - при первой ошибке выбрасывается `SyntaxException`, в `stderr` вы увидите, например:
    - `Syntax error: line 1:4 token recognition error at: '1'`

### 3. Сборка проекта и запуск тестов

Требования:
- установлен JDK (Java 17+; в POM указана 23);
- установлен Maven.

- **Сборка и генерация парсера**:
  - `mvn compile`
- **Запуск тестов**:
  - `mvn test`

Maven-плагин ANTLR автоматически запускается на фазе `generate-sources`.

### 4. Запуск в IntelliJ IDEA

#### Способ 1: Через конфигурацию Run/Debug (РЕКОМЕНДУЕТСЯ)

1. **Откройте файл** `src/main/java/org/example/Main.java`
2. **Первый запуск**: Нажмите правой кнопкой на зелёном треугольнике слева от `public static void main` → выберите **"Run 'Main.main()'"** (или **Ctrl+Shift+F10**)
   - При первом запуске программа завершится с ошибкой — это нормально, нужно настроить аргументы
3. **Настройка аргументов**:
   - Вверху экрана найдите выпадающий список конфигураций (рядом с кнопками Run/Debug)
   - Выберите **"Edit Configurations..."** (или **Alt+Shift+F10**, затем **0**)
   - В поле **"Program arguments"** введите: `-i test.conf`
   - Нажмите **OK**
4. **Запуск**: Нажмите **Run** (зелёный треугольник) или **Shift+F10**
5. **Результат**: XML появится в консоли внизу

**Примеры аргументов для разных файлов:**
- `-i test.conf` — простой тест
- `-i src/main/resources/examples/network.conf` — сетевая конфигурация
- `-i src/main/resources/examples/game.conf` — игровая конфигурация

#### Способ 2: Запуск тестов

1. Откройте класс `src/test/java/org/example/ConfigLangTest.java`
2. Нажмите правой кнопкой на имени класса или конкретном тесте
3. Выберите **"Run 'ConfigLangTest'"**
4. Результаты появятся в окне Run

Или через терминал IDEA: `mvn test`

#### Способ 3: Через терминал IntelliJ IDEA

1. Откройте терминал: **View** → **Tool Windows** → **Terminal** (или **Alt+F12**)
2. Выполните:
   ```bash
   mvn compile
   java -cp "target/classes;target/dependency/*" org.example.Main -i test.conf
   ```

Подробная инструкция также в файле `INTELLIJ_SETUP.md`.

### 5. Использование CLI

После сборки можно запустить утилиту двумя способами:

- **Прямой запуск через Maven**:
  - `mvn -q exec:java -Dexec.mainClass=org.example.Main -Dexec.args="-i src/main/resources/examples/network.conf"`
  - (для этого можно добавить `maven-exec-plugin`, либо запустить через IDE).

- **Запуск собранного JAR** (при наличии `jar` с манифестом):
  - `java -jar config-lang-cli.jar -i path/to/file.conf`

Формат команды:
- `-i <input-file>` — путь к входному файлу.

При успешном разборе в `stdout` попадает XML. При ошибке синтаксиса код возврата — 2, сообщение об ошибке в `stderr`.

### 6. Примеры конфигураций (2 предметные области)

- **1) Сетевая конфигурация** — файл `src/main/resources/examples/network.conf`:

```text
// Пример 1: сетевая конфигурация
var basePort 0b100000
^(+ basePort 0b000010)

[ host => 0b00000001,
  port => 0b100010
]
```

Кратко:
- объявляется константа `basePort`;
- вычисляется выражение `^(+ basePort 0b000010)` (увеличение порта);
- задаётся словарь с хостом и портом.

- **2) Игровая конфигурация** — файл `src/main/resources/examples/game.conf`:

```text
// Пример 2: игровая конфигурация
var maxPlayers 0b001000
^(sqrt maxPlayers)

[ level1 => [ enemies => 0b000001, bonuses => 0b000010 ],
  level2 => [ enemies => 0b000011, bonuses => 0b000100 ]
]
```

Кратко:
- объявляется константа `maxPlayers`;
- константное выражение `^(sqrt maxPlayers)` вычисляет корень (целую часть);
- описывается словарь уровней игры с вложенными словарями параметров.

Оба примера покрыты тестами и демонстрируют:
- объявления констант;
- вычисление выражений с `+` и `sqrt`;
- словари с вложенностью;
- комментарии.


